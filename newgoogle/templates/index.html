<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live AI Captions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #caption-container::-webkit-scrollbar { width: 8px; }
        #caption-container::-webkit-scrollbar-track { background: #f1f5f9; }
        #caption-container::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        #caption-container::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .caption-card { transition: all 0.3s ease-in-out; }
        .placeholder-text { color: #94a3b8; font-style: italic; }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-5xl mx-auto flex flex-col h-[90vh] bg-slate-800 rounded-2xl shadow-2xl overflow-hidden">
        
        <header class="flex-shrink-0 bg-slate-900/50 p-4 border-b border-slate-700 flex flex-wrap md:flex-nowrap items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 rounded-full bg-red-500" id="status-indicator"></div>
                <h1 class="text-xl font-bold text-white">Live AI Captions</h1>
                <span id="status-text" class="text-sm text-slate-400">Disconnected</span>
            </div>

            <div class="flex flex-wrap items-center gap-4 w-full md:w-auto">
                <div class="flex items-center gap-2">
                    <label for="source-lang" class="text-sm font-medium text-slate-300">Speak:</label>
                    <select id="source-lang" class="bg-slate-700 text-white text-sm rounded-md border-slate-600 focus:ring-blue-500 focus:border-blue-500 p-2"></select>
                </div>
                
                <div class="flex items-center gap-2">
                    <label for="target-lang" class="text-sm font-medium text-slate-300">Show:</label>
                    <select id="target-lang" class="bg-slate-700 text-white text-sm rounded-md border-slate-600 focus:ring-blue-500 focus:border-blue-500 p-2"></select>
                </div>

                <div class="flex items-center gap-2">
                    <input type="checkbox" id="simplify-check" checked class="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500">
                    <label for="simplify-check" class="text-sm font-medium text-slate-300">Simplify</label>
                </div>

                <button id="start-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all shadow-lg">
                    Start Listening
                </button>
                <button id="stop-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-all shadow-lg hidden">
                    Stop Listening
                </button>
            </div>
        </header>

        <div id="error-box" class="flex-shrink-0 p-4 bg-red-800 border-b border-red-600 text-red-100 hidden">
            <p id="error-message"></p>
        </div>

        <main id="caption-container" class="flex-grow p-6 overflow-y-auto space-y-4 bg-slate-800 scroll-smooth">
            <div class="text-slate-400 text-center py-10">
                Click "Start Listening" to see live captions.
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io.connect(window.location.origin);
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const sourceLangSelect = document.getElementById('source-lang');
            const targetLangSelect = document.getElementById('target-lang');
            const simplifyCheck = document.getElementById('simplify-check');
            const captionContainer = document.getElementById('caption-container');
            const errorBox = document.getElementById('error-box');
            const errorMessage = document.getElementById('error-message');

            let audioContext;
            let mediaStream;
            let audioInput;
            let scriptProcessor;
            let currentSessionId = null;
            let isListening = false;
            let hasStarted = false;

            // Socket event handlers
            socket.on('connect', () => {
                statusIndicator.classList.remove('bg-red-500');
                statusIndicator.classList.add('bg-green-500');
                statusText.textContent = 'Connected';
                console.log('Socket connected');
            });

            socket.on('disconnect', () => {
                statusIndicator.classList.remove('bg-green-500');
                statusIndicator.classList.add('bg-red-500');
                statusText.textContent = 'Disconnected';
                console.log('Socket disconnected');
                stopListening();
            });

            socket.on('error', (data) => {
                console.error('Server Error:', data.message);
                showError(data.message);
            });

            socket.on('stream_started', (data) => {
                currentSessionId = data.session_id;
                console.log('Stream started:', currentSessionId);
            });

            socket.on('stream_stopped', (data) => {
                console.log('Stream stopped:', data.session_id);
                currentSessionId = null;
            });

            socket.on('caption_result', (data) => {
                console.log('Caption received:', data);
                if (!hasStarted) {
                    captionContainer.innerHTML = '';
                    hasStarted = true;
                }
                
                const card = document.createElement('div');
                card.id = `caption-${data.id}`;
                card.className = 'caption-card bg-slate-700 p-4 rounded-lg shadow-md border-l-4 border-blue-500';
                
                card.innerHTML = `
                    <p class="text-lg font-medium text-white" data-field="original">${data.original}</p>
                    <p class="text-md text-blue-300 mt-2" data-field="translated">
                        <span class="placeholder-text">Translating...</span>
                    </p>
                    <p class="text-md text-green-300 mt-1" data-field="simplified">
                        <span class="placeholder-text">Simplifying...</span>
                    </p>
                    <p class="text-xs text-slate-400 mt-2">Confidence: ${Math.round(data.confidence * 100)}%</p>
                `;
                
                captionContainer.appendChild(card);
                captionContainer.scrollTop = captionContainer.scrollHeight;
            });

            socket.on('caption_update', (data) => {
                console.log('Caption update:', data);
                const card = document.getElementById(`caption-${data.id}`);
                if (!card) return;

                if (data.translated !== undefined) {
                    const el = card.querySelector('[data-field="translated"]');
                    if (el) el.textContent = data.translated;
                }

                if (data.simplified !== undefined) {
                    const el = card.querySelector('[data-field="simplified"]');
                    if (el) el.textContent = data.simplified;
                }
            });

            // Audio processing
            function downsampleBuffer(buffer, inputSampleRate, outputSampleRate) {
                if (inputSampleRate === outputSampleRate) {
                    return buffer;
                }
                const sampleRateRatio = inputSampleRate / outputSampleRate;
                const newLength = Math.round(buffer.length / sampleRateRatio);
                const result = new Float32Array(newLength);
                let offsetResult = 0;
                let offsetBuffer = 0;
                
                while (offsetResult < result.length) {
                    const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                    let accum = 0, count = 0;
                    for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                        accum += buffer[i];
                        count++;
                    }
                    result[offsetResult] = accum / count;
                    offsetResult++;
                    offsetBuffer = nextOffsetBuffer;
                }
                return result;
            }

            function floatTo16BitPCM(float32Array) {
                const buffer = new ArrayBuffer(float32Array.length * 2);
                const view = new DataView(buffer);
                let offset = 0;
                for (let i = 0; i < float32Array.length; i++, offset += 2) {
                    const s = Math.max(-1, Math.min(1, float32Array[i]));
                    view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
                }
                return buffer;
            }

            async function startListening() {
                if (isListening) return;

                try {
                    // Get microphone access
                    mediaStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            channelCount: 1,
                            sampleRate: 48000
                        }
                    });

                    // Create audio context
                    audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 48000
                    });
                    
                    audioInput = audioContext.createMediaStreamSource(mediaStream);
                    scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);

                    // Process audio chunks
                    scriptProcessor.onaudioprocess = (e) => {
                        if (!isListening || !currentSessionId) return;

                        const inputData = e.inputBuffer.getChannelData(0);
                        
                        // Downsample to 16kHz (Google Speech requirement)
                        const downsampled = downsampleBuffer(inputData, 48000, 16000);
                        
                        // Convert to 16-bit PCM
                        const pcm = floatTo16BitPCM(downsampled);
                        
                        // Convert to base64
                        const base64Audio = btoa(
                            new Uint8Array(pcm).reduce((data, byte) => data + String.fromCharCode(byte), '')
                        );
                        
                        // Send to server
                        socket.emit('audio_chunk', {
                            session_id: currentSessionId,
                            audio: base64Audio
                        });
                    };

                    audioInput.connect(scriptProcessor);
                    scriptProcessor.connect(audioContext.destination);

                    // Start streaming session
                    socket.emit('start_stream', {
                        source_language: sourceLangSelect.value,
                        target_language: targetLangSelect.value,
                        simplify: simplifyCheck.checked
                    });

                    isListening = true;
                    startBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                    statusText.textContent = 'Listening...';
                    statusIndicator.classList.add('animate-pulse');

                } catch (err) {
                    console.error('Error starting:', err);
                    showError('Could not access microphone. Please check permissions.');
                }
            }

            function stopListening() {
                if (!isListening) return;

                isListening = false;

                if (currentSessionId) {
                    socket.emit('stop_stream', { session_id: currentSessionId });
                }

                if (scriptProcessor) {
                    scriptProcessor.disconnect();
                    scriptProcessor = null;
                }

                if (audioInput) {
                    audioInput.disconnect();
                    audioInput = null;
                }

                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }

                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }

                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                statusText.textContent = 'Connected';
                statusIndicator.classList.remove('animate-pulse');
            }

            function showError(message) {
                errorMessage.textContent = message;
                errorBox.classList.remove('hidden');
                setTimeout(() => errorBox.classList.add('hidden'), 5000);
            }

            async function populateLanguages() {
                try {
                    const response = await fetch('/api/languages');
                    const data = await response.json();

                    for (const [code, name] of Object.entries(data.source_languages)) {
                        sourceLangSelect.add(new Option(name, code));
                    }

                    for (const [code, name] of Object.entries(data.target_languages)) {
                        targetLangSelect.add(new Option(name, code));
                    }
                    
                    sourceLangSelect.value = 'en-IN';
                    targetLangSelect.value = 'hi';

                } catch (err) {
                    console.error('Error loading languages:', err);
                    showError('Could not load languages');
                }
            }

            startBtn.addEventListener('click', startListening);
            stopBtn.addEventListener('click', stopListening);
            
            populateLanguages();
        });
    </script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live AI Captions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <link href__="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif;
        }
        
        #caption-container::-webkit-scrollbar { 
            width: 8px; 
        }
        
        #caption-container::-webkit-scrollbar-track { 
            background: #f3e8ff;
        }
        
        #caption-container::-webkit-scrollbar-thumb { 
            background: #c084fc; 
            border-radius: 4px; 
        }
        
        #caption-container::-webkit-scrollbar-thumb:hover { 
            background: #a855f7; 
        }
        
        .caption-card { 
            animation: slideInFromBottom 0.4s ease-out;
        }
        
        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        
        .hover-scale {
            transition: transform 0.2s ease-in-out;
        }
        
        .hover-scale:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-violet-50 via-pink-50 to-blue-50">

    <div class="p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            
            <!-- Header Card -->
            <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl shadow-violet-200/50 p-6 mb-6 border border-white/20">
                <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6">
                    
                    <!-- Title & Status -->
                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center shadow-lg shadow-violet-300/50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                    <line x1="12" x2="12" y1="19" y2="22"/>
                                </svg>
                            </div>
                            <div id="listening-indicator" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full pulse-dot border-2 border-white shadow-lg"></div>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold bg-gradient-to-r from-violet-600 to-purple-600 bg-clip-text text-transparent">
                                Live AI Captions
                            </h1>
                            <div class="flex items-center gap-2 mt-1">
                                <svg id="status-icon-connected" class="w-4 h-4 text-green-500 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M5 13a10 10 0 0 1 14 0"/>
                                    <path d="M8.5 16.5a5 5 0 0 1 7 0"/>
                                    <path d="M2 8.82a15 15 0 0 1 20 0"/>
                                    <line x1="12" x2="12.01" y1="20" y2="20"/>
                                </svg>
                                <svg id="status-icon-disconnected" class="w-4 h-4 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="2" x2="22" y1="2" y2="22"/>
                                    <path d="M10.66 5.07A10.5 10.5 0 0 1 21 12.07"/>
                                    <path d="M5 13a10 10 0 0 1 5.34-2.07"/>
                                    <path d="M16.5 16.5a5 5 0 0 0-7 0"/>
                                    <path d="M8.5 16.5a5 5 0 0 1 7 0"/>
                                    <line x1="12" x2="12.01" y1="20" y2="20"/>
                                </svg>
                                <span id="status-text" class="text-sm text-gray-600">Disconnected</span>
                            </div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="flex flex-wrap items-center gap-4 w-full lg:w-auto">
                        <div class="flex items-center gap-2 bg-gradient-to-br from-blue-50 to-indigo-50 px-4 py-2 rounded-xl border border-blue-100 shadow-sm">
                            <label class="text-sm font-medium text-gray-700">Speak:</label>
                            <select id="source-lang" class="bg-white text-gray-800 text-sm rounded-lg border-gray-200 focus:ring-2 focus:ring-violet-500 focus:border-transparent px-3 py-1.5 shadow-sm"></select>
                        </div>

                        <div class="flex items-center gap-2 bg-gradient-to-br from-purple-50 to-pink-50 px-4 py-2 rounded-xl border border-purple-100 shadow-sm">
                            <label class="text-sm font-medium text-gray-700">Show:</label>
                            <select id="target-lang" class="bg-white text-gray-800 text-sm rounded-lg border-gray-200 focus:ring-2 focus:ring-violet-500 focus:border-transparent px-3 py-1.5 shadow-sm"></select>
                        </div>

                        <label class="flex items-center gap-2 bg-gradient-to-br from-green-50 to-emerald-50 px-4 py-2 rounded-xl border border-green-100 shadow-sm cursor-pointer hover-scale">
                            <input type="checkbox" id="simplify-check" checked class="w-4 h-4 text-violet-600 bg-white border-gray-300 rounded focus:ring-violet-500">
                            <span class="text-sm font-medium text-gray-700">Simplify</span>
                        </label>

                        <button id="start-btn" class="bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-700 hover:to-purple-700 text-white font-semibold px-6 py-2 rounded-xl shadow-lg shadow-violet-300/50 hover:shadow-xl hover:shadow-violet-400/50 transition-all hover-scale flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                <line x1="12" x2="12" y1="19" y2="22"/>
                            </svg>
                            Start Listening
                        </button>
                        
                        <button id="stop-btn" class="hidden bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white font-semibold px-6 py-2 rounded-xl shadow-lg shadow-red-300/50 hover:shadow-xl hover:shadow-red-400/50 transition-all hover-scale flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="2" x2="22" y1="2" y2="22"/>
                                <path d="M18.89 13.23A7.12 7.12 0 0 0 19 12v-2"/>
                                <path d="M5 10v2a7 7 0 0 0 12 5"/>
                                <path d="M15 9.34V5a3 3 0 0 0-5.68-1.33"/>
                                <path d="M9 9v3a3 3 0 0 0 5.12 2.12"/>
                                <line x1="12" x2="12" y1="19" y2="22"/>
                            </svg>
                            Stop Listening
                        </button>
                    </div>
                </div>
            </div>

            <!-- Error Alert -->
            <div id="error-box" class="hidden mb-6 bg-red-50 border-red-200 shadow-lg shadow-red-200/50 rounded-2xl p-4 flex items-start gap-3 border">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" x2="12" y1="8" y2="12"/>
                    <line x1="12" x2="12.01" y1="16" y2="16"/>
                </svg>
                <p id="error-message" class="text-red-800 font-medium"></p>
            </div>

            <!-- Captions Container -->
            <div class="bg-white/70 backdrop-blur-xl rounded-3xl shadow-2xl shadow-violet-200/50 border border-white/20 overflow-hidden">
                <div id="caption-container" class="h-[calc(100vh-280px)] overflow-y-auto p-6 space-y-4 scroll-smooth">
                    <div id="empty-state" class="h-full flex flex-col items-center justify-center text-center">
                        <div class="w-32 h-32 mb-6 rounded-full bg-gradient-to-br from-violet-100 to-purple-100 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 text-violet-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                <line x1="12" x2="12" y1="19" y2="22"/>
                            </svg>
                        </div>
                        <p class="text-xl font-medium text-gray-600 mb-2">Ready to Start</p>
                        <p class="text-gray-500">Click "Start Listening" to see live captions appear here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io.connect(window.location.origin);
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const statusIconConnected = document.getElementById('status-icon-connected');
            const statusIconDisconnected = document.getElementById('status-icon-disconnected');
            const statusText = document.getElementById('status-text');
            const listeningIndicator = document.getElementById('listening-indicator');
            const sourceLangSelect = document.getElementById('source-lang');
            const targetLangSelect = document.getElementById('target-lang');
            const simplifyCheck = document.getElementById('simplify-check');
            const captionContainer = document.getElementById('caption-container');
            const emptyState = document.getElementById('empty-state');
            const errorBox = document.getElementById('error-box');
            const errorMessage = document.getElementById('error-message');

            let audioContext;
            let mediaStream;
            let audioInput;
            let scriptProcessor;
            let currentSessionId = null;
            let isListening = false;
            let hasStarted = false;

            // Socket event handlers
            socket.on('connect', () => {
                statusIconConnected.classList.remove('hidden');
                statusIconDisconnected.classList.add('hidden');
                statusText.textContent = 'Connected';
                console.log('Socket connected');
            });

            socket.on('disconnect', () => {
                statusIconConnected.classList.add('hidden');
                statusIconDisconnected.classList.remove('hidden');
                statusText.textContent = 'Disconnected';
                console.log('Socket disconnected');
                stopListening();
            });

            socket.on('error', (data) => {
                console.error('Server Error:', data.message);
                showError(data.message);
            });

            socket.on('stream_started', (data) => {
                currentSessionId = data.session_id;
                console.log('Stream started:', currentSessionId);
            });

            socket.on('stream_stopped', (data) => {
                console.log('Stream stopped:', data.session_id);
                currentSessionId = null;
            });

            socket.on('caption_result', (data) => {
                console.log('Caption received:', data);
                if (!hasStarted) {
                    emptyState.classList.add('hidden');
                    hasStarted = true;
                }
                
                const card = document.createElement('div');
                card.id = `caption-${data.id}`;
                card.className = 'caption-card bg-white rounded-2xl p-5 shadow-lg hover:shadow-xl transition-all duration-300 border-l-4 border-violet-500';
                
                card.innerHTML = `
                    <!-- Original Text -->
                    <div class="mb-3">
                        <div class="text-xs font-semibold text-gray-500 mb-1 uppercase tracking-wide">Original</div>
                        <p class="text-lg font-medium text-gray-900" data-field="original">${data.original}</p>
                    </div>

                    <!-- Translated Text -->
                    <div class="mb-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-3 border border-blue-100">
                        <div class="text-xs font-semibold text-blue-600 mb-1 uppercase tracking-wide">Translated</div>
                        <p class="text-base text-blue-900" data-field="translated">
                            <span class="italic text-blue-400">Translating...</span>
                        </p>
                    </div>

                    <!-- Simplified Text -->
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-3 border border-green-100">
                        <div class="text-xs font-semibold text-green-600 mb-1 uppercase tracking-wide">Simplified</div>
                        <p class="text-base text-green-900" data-field="simplified">
                            <span class="italic text-green-400">Simplifying...</span>
                        </p>
                    </div>

                    <!-- Confidence Badge -->
                    <div class="mt-3 flex items-center justify-between">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-violet-100 to-purple-100 text-violet-700 border border-violet-200">
                            Confidence: ${Math.round(data.confidence * 100)}%
                        </span>
                    </div>
                `;
                
                captionContainer.appendChild(card);
                captionContainer.scrollTop = captionContainer.scrollHeight;
            });

            socket.on('caption_update', (data) => {
                console.log('Caption update:', data);
                const card = document.getElementById(`caption-${data.id}`);
                if (!card) return;

                if (data.translated !== undefined) {
                    const el = card.querySelector('[data-field="translated"]');
                    if (el) el.textContent = data.translated;
                }

                if (data.simplified !== undefined) {
                    const el = card.querySelector('[data-field="simplified"]');
                    if (el) el.textContent = data.simplified;
                }
            });

            // Audio processing
            function downsampleBuffer(buffer, inputSampleRate, outputSampleRate) {
                if (inputSampleRate === outputSampleRate) {
                    return buffer;
                }
                const sampleRateRatio = inputSampleRate / outputSampleRate;
                const newLength = Math.round(buffer.length / sampleRateRatio);
                const result = new Float32Array(newLength);
                let offsetResult = 0;
                let offsetBuffer = 0;
                
                while (offsetResult < result.length) {
                    const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                    let accum = 0, count = 0;
                    for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                        accum += buffer[i];
                        count++;
                    }
                    result[offsetResult] = accum / count;
                    offsetResult++;
                    offsetBuffer = nextOffsetBuffer;
                }
                return result;
            }

            function floatTo16BitPCM(float32Array) {
                const buffer = new ArrayBuffer(float32Array.length * 2);
                const view = new DataView(buffer);
                let offset = 0;
                for (let i = 0; i < float32Array.length; i++, offset += 2) {
                    const s = Math.max(-1, Math.min(1, float32Array[i]));
                    view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
                }
                return buffer;
            }

            async function startListening() {
                if (isListening) return;

                try {
                    // Get microphone access
                    mediaStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            channelCount: 1,
                            sampleRate: 48000
                        }
                    });

                    // Create audio context
                    audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 48000
                    });
                    
                    audioInput = audioContext.createMediaStreamSource(mediaStream);
                    scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);

                    // Process audio chunks
                    scriptProcessor.onaudioprocess = (e) => {
                        if (!isListening || !currentSessionId) return;

                        const inputData = e.inputBuffer.getChannelData(0);
                        
                        // Downsample to 16kHz (Google Speech requirement)
                        const downsampled = downsampleBuffer(inputData, 48000, 16000);
                        
                        // Convert to 16-bit PCM
                        const pcm = floatTo16BitPCM(downsampled);
                        
                        // Convert to base64
                        const base64Audio = btoa(
                            new Uint8Array(pcm).reduce((data, byte) => data + String.fromCharCode(byte), '')
                        );
                        
                        // Send to server
                        socket.emit('audio_chunk', {
                            session_id: currentSessionId,
                            audio: base64Audio
                        });
                    };

                    audioInput.connect(scriptProcessor);
                    scriptProcessor.connect(audioContext.destination);

                    // Start streaming session
                    socket.emit('start_stream', {
                        source_language: sourceLangSelect.value,
                        target_language: targetLangSelect.value,
                        simplify: simplifyCheck.checked
                    });

                    isListening = true;
                    startBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                    statusText.textContent = 'Listening...';
                    listeningIndicator.classList.remove('hidden');

                } catch (err) {
                    console.error('Error starting:', err);
                    showError('Could not access microphone. Please check permissions.');
                }
            }

            function stopListening() {
                if (!isListening) return;

                isListening = false;

                if (currentSessionId) {
                    socket.emit('stop_stream', { session_id: currentSessionId });
                }

                if (scriptProcessor) {
                    scriptProcessor.disconnect();
                    scriptProcessor = null;
                }

                if (audioInput) {
                    audioInput.disconnect();
                    audioInput = null;
                }

                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }

                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }

                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                statusText.textContent = 'Connected';
                listeningIndicator.classList.add('hidden');
            }

            function showError(message) {
                errorMessage.textContent = message;
                errorBox.classList.remove('hidden');
                setTimeout(() => errorBox.classList.add('hidden'), 5000);
            }

            async function populateLanguages() {
                try {
                    const response = await fetch('/api/languages');
                    const data = await response.json();

                    for (const [code, name] of Object.entries(data.source_languages)) {
                        sourceLangSelect.add(new Option(name, code));
                    }

                    for (const [code, name] of Object.entries(data.target_languages)) {
                        targetLangSelect.add(new Option(name, code));
                    }
                    
                    sourceLangSelect.value = 'en-IN';
                    targetLangSelect.value = 'hi';

                } catch (err) {
                    console.error('Error loading languages:', err);
                    showError('Could not load languages');
                }
            }

            startBtn.addEventListener('click', startListening);
            stopBtn.addEventListener('click', stopListening);
            
            populateLanguages();
        });
    </script>
</body>
</html>